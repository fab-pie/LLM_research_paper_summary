<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local LLM Literature Reviewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- Transformers.js for embeddings -->
    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';
        
        // Disable local model loading, use remote models
        env.allowLocalModels = false;
        
        // Make pipeline available globally
        window.transformersPipeline = pipeline;
    </script>
    <!-- WebLLM for chat -->
    <script type="module">
        import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";
        window.CreateMLCEngine = CreateMLCEngine;
    </script>
        <style>
            /* Sober white theme overrides */
            :root { --muted:#f7f7f7; --panel:#ffffff; --border:#e6e6e6; --text:#111; --muted-text:#555; --accent:#0b5fff; }
            body { background: var(--panel); color: var(--text); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; font-size:15px; }
            h1 { font-size:22px; color:var(--text); font-weight:600; margin-bottom:12px; }
            h2 { font-size:16px; color:var(--text); font-weight:600; }
            h3 { font-size:15px; color:var(--text); font-weight:600; }
            .container { max-width:980px; margin:0 auto; padding:32px; }
            /* Override dark Tailwind classes to light panels */
            .bg-gray-900, .bg-gray-800, .bg-gray-700 { background: var(--muted) !important; color:var(--text) !important; }
            .text-white { color:var(--text) !important; }
            .text-gray-300, .text-gray-400, .text-gray-500, .text-gray-600, .text-gray-700 { color:var(--muted-text) !important; }
            .border-gray-600, .border-gray-700 { border-color: var(--border) !important; }
            button, .btn-primary { background: transparent; color: var(--accent); border:1px solid var(--border); padding:0.5rem 1rem; border-radius:8px; cursor:pointer; }
            button.bg-blue-600, button.bg-green-600, button.bg-black { background: transparent !important; color:var(--accent) !important; border:1px solid var(--border) !important; }
            input, select, textarea { background: white !important; color:var(--text) !important; border:1px solid var(--border); padding:0.5rem; border-radius:6px; font-size:15px; }
            #dropZone { background: transparent !important; border:1px dashed var(--border); }
            #chatSection .bg-gray-800, #chunksSection .bg-gray-800 { background: #fff !important; border:1px solid var(--border); }
            #progressBar { background: var(--accent) !important; }
            /* Tighter spacing */
            .p-8 { padding: 20px !important; }
            .p-6 { padding: 16px !important; }
            .p-4 { padding: 12px !important; }
            .mb-8 { margin-bottom:18px !important; }
            .rounded-lg { border-radius:8px !important; }
            /* Typing indicator dots */
            .typing-dots { display: inline-flex; gap: 6px; align-items: center; }
            .typing-dots .dot { width: 8px; height: 8px; background: #111; border-radius: 9999px; opacity: 0.25; transform: translateY(0); animation: typing 1s infinite; }
            .typing-dots .dot:nth-child(1) { animation-delay: 0s; }
            .typing-dots .dot:nth-child(2) { animation-delay: 0.15s; }
            .typing-dots .dot:nth-child(3) { animation-delay: 0.3s; }
            @keyframes typing {
                0% { opacity: 0.25; transform: translateY(0); }
                50% { opacity: 1; transform: translateY(-6px); }
                100% { opacity: 0.25; transform: translateY(0); }
            }
        </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- PDF Loading Overlay -->
    <div id="pdfLoadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
        <div class="bg-white text-black p-6 rounded-lg shadow-lg w-80">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 border-4 border-t-4 border-gray-200 rounded-full animate-spin"></div>
                <div>
                    <div id="pdfLoadingText" class="font-medium">Processing PDFs...</div>
                    <div id="pdfLoadingSub" class="text-sm text-gray-600">Preparing...</div>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-4">
                <div id="pdfLoadingBar" class="bg-blue-600 h-2 rounded-full" style="width:0%"></div>
            </div>
            <div class="text-right text-sm text-gray-600 mt-2" id="pdfLoadingPercent">0%</div>
        </div>
    </div>
    <div class="container mx-auto p-8">
        <h1 class="text-4xl font-bold mb-8 text-center">Local LLM Literature Reviewer</h1>
        
        <!-- PDF Upload Zone - Full Width -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Upload Research Papers</h2>
            <div id="dropZone" class="border-4 border-dashed border-gray-600 rounded-lg p-12 text-center cursor-pointer hover:border-blue-500 transition-colors">
                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="text-lg mb-2">Drag & Drop PDF files here</p>
                <p class="text-gray-400 mb-4">or</p>
                <button class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold">Browse Files</button>
                <input type="file" id="fileInput" accept=".pdf" multiple class="hidden">
            </div>
        </div>

        <!-- Model Selection - Compact -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-3">LLM Model</h2>
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="flex gap-4 items-center justify-between">
                    <div class="flex-1">
                        <p class="text-gray-300 text-sm">Model: <span class="font-bold text-black">Llama 3.2 1B</span> (Fast, 600MB)</p>
                    </div>
                    <button 
                        id="loadModelButton" 
                        class="bg-black hover:bg-gray-900 px-6 py-2 rounded-lg font-bold disabled:bg-gray-600 disabled:cursor-not-allowed whitespace-nowrap text-white"
                    >
                        Load Model
                    </button>
                </div>
                
                <!-- Loading Progress -->
                <div id="loadingProgress" class="mt-4 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-300" id="loadingText">Initializing...</span>
                        <span class="text-sm text-gray-400" id="loadingPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Model Info -->
                <div id="modelInfo" class="mt-3 p-3 bg-gray-900 rounded text-sm hidden">
                    <p class="text-black font-bold"><span id="modelName"></span> loaded successfully!</p>
                </div>
                <!-- Temperature Control -->
                <div class="mt-4 p-3 bg-gray-900 rounded text-sm">
                    <label for="tempSlider" class="block text-gray-300 text-sm mb-2">Temperature (creativity vs. factuality): <span id="tempValue" class="text-black font-bold">0.20</span></label>
                    <input id="tempSlider" type="range" min="0" max="1" step="0.01" value="0.2" class="w-full">
                </div>
            </div>
        </div>

        <!-- Status & Results -->
        <div id="status" class="mb-8 p-4 bg-gray-800 rounded-lg hidden">
            <h3 class="text-xl font-semibold mb-2">Processing Status</h3>
            <div id="statusContent" class="text-gray-300"></div>
        </div>

        <!-- Processed Documents -->
        <div id="documentsSection" class="mb-8 hidden">
            <h2 class="text-2xl font-semibold mb-4">Processed Documents</h2>
            <div id="documentsList" class="space-y-2"></div>
        </div>

        <!-- Vector Search Test -->
        <div id="searchSection" class="mb-8 hidden">
            <h2 class="text-2xl font-semibold mb-4">Test Vector Search</h2>
            <div class="bg-gray-800 p-6 rounded-lg">
                <div class="mb-4">
                    <label class="block text-gray-300 mb-2">Enter a query to search the documents:</label>
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g., machine learning techniques, neural networks..."
                    >
                </div>
                <button 
                    id="searchButton" 
                    class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold"
                >
                    Search
                </button>
                <div id="searchResults" class="mt-6"></div>
            </div>
        </div>

        

        <!-- Chat Interface -->
        <div id="chatSection" class="mb-8 hidden">
            <h2 class="text-2xl font-semibold mb-4">Chat with Literature Reviewer</h2>
            <div class="bg-gray-800 rounded-lg flex flex-col" style="height: 600px;">
                <!-- Chat Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                    <div class="text-center text-gray-500 text-sm">
                        Start a conversation by typing a message below
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="border-t border-gray-700 p-4">
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="chatInput" 
                            class="flex-1 bg-gray-700 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Ask about your uploaded papers..."
                        >
                        <button 
                            id="sendButton" 
                            class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold disabled:bg-gray-600 disabled:cursor-not-allowed"
                        >
                            Send
                        </button>
                    </div>
                    <div class="mt-2 flex items-center gap-2">
                        <input type="checkbox" id="useRAG" class="w-4 h-4" checked>
                        <label for="useRAG" class="text-sm text-gray-400">Use RAG (search documents before answering)</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chunks Display (for debugging) -->
        <div id="chunksSection" class="mb-8 hidden">
            <h2 class="text-2xl font-semibold mb-4">Text Chunks</h2>
            <div id="chunksList" class="bg-gray-800 p-4 rounded-lg max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
